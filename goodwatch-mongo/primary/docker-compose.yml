version: "3.8"

services:
  mongo:
    container_name: mongo
    hostname: mongo
    image: mongo:8
    network_mode: "host"
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ADMIN_PASS}
      - MONGO_INITDB_DATABASE=goodwatch
    ports:
      - "28017:28017"
    volumes:
      - mongodb:/data/db
      - ./mongodb-keyfile:/data/mongodb-keyfile
    healthcheck:
      test: ["CMD-SHELL", "mongosh --port 28017 --eval 'db.runCommand(\"ping\").ok' --quiet"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
    command: >
      --replSet rs0 
      --bind_ip_all 
      --port 28017 
      --keyFile /data/mongodb-keyfile 

  mongoinit:
    container_name: mongoinit
    image: mongo:8
    network_mode: "host"
    restart: "no"
    depends_on:
      mongo:
        condition: service_healthy
    command: >
      bash -c "
        set -e
        echo '--- Waiting for mongo to be ready...'
        until mongosh --host localhost --port 28017 --eval 'quit(0)' --quiet; do
          sleep 2
        done

        echo '--- Checking Replica Set Status...'
        # We run a JS script to handle the logic intelligently
        mongosh --host localhost --port 28017 -u admin -p \"${MONGO_ADMIN_PASS}\" --authenticationDatabase admin --eval '
          try {
            const status = rs.status();
            if (status.ok === 1) {
              print(\"--- Replica Set already initialized. Checking members...\");
            }
          } catch (e) {
            if (e.codeName === \"NotYetInitialized\" || e.message.includes(\"no replset config\")) {
              print(\"--- Initiating new Replica Set...\");
              rs.initiate({
                _id: \"rs0\",
                members: [
                  { _id: 0, host: \"10.0.0.17:28017\", priority: 2 }
                ]
              });
            } else {
              throw e;
            }
          }
        '

        echo '--- Waiting for PRIMARY status...'
        # Wait until WE are primary or can see a primary
        until mongosh --host localhost --port 28017 -u admin -p \"${MONGO_ADMIN_PASS}\" --authenticationDatabase admin --eval 'if (!rs.isMaster().ismaster) { quit(1); }' --quiet; do
            echo 'Waiting to become Primary...'
            sleep 2
        done

        echo '--- Ensuring Secondary Nodes are added...'
        # rs.add is safe to run multiple times; it will error harmlessly if they exist, 
        # but we wrap it to be clean.
        mongosh --host localhost --port 28017 -u admin -p \"${MONGO_ADMIN_PASS}\" --authenticationDatabase admin --eval '
          const config = rs.config();
          const hosts = config.members.map(m => m.host);
          
          if (!hosts.includes(\"10.0.0.18:28017\")) {
             print(\"Adding 10.0.0.18...\");
             rs.add(\"10.0.0.18:28017\");
          }
          if (!hosts.includes(\"10.0.0.19:28017\")) {
             print(\"Adding 10.0.0.19...\");
             rs.add(\"10.0.0.19:28017\");
          }
        '

        echo '--- Creating application user (Idempotent)...'
        mongosh --host localhost --port 28017 -u admin -p \"${MONGO_ADMIN_PASS}\" --authenticationDatabase admin --eval '
          db.getSiblingDB(\"goodwatch\").createUser({
            user: \"goodwatch\",
            pwd: \"${MONGO_GOODWATCH_PASS}\",
            roles: [
              { role: \"readWrite\", db: \"goodwatch\" },
              { role: \"dbAdmin\", db: \"goodwatch\" }
            ]
          });
        ' || echo 'User likely already exists, skipping...'

        echo 'âœ… Cluster is healthy.'
      "

volumes:
  mongodb:
